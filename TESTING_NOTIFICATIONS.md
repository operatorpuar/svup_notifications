# –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è Push-—Å–ø–æ–≤—ñ—â–µ–Ω—å

## –®–≤–∏–¥–∫–∏–π —Å—Ç–∞—Ä—Ç

### –ö—Ä–æ–∫ 1: –ü—ñ–¥–≥–æ—Ç–æ–≤–∫–∞
1. –ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—å —â–æ dev server –∑–∞–ø—É—â–µ–Ω–æ: `npm run dev`
2. –£–≤—ñ–π–¥—ñ—Ç—å –≤ —Å–∏—Å—Ç–µ–º—É: `http://localhost:4321`
3. –î–æ–∑–≤–æ–ª—å—Ç–µ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è –∫–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä –∑–∞–ø–∏—Ç–∞—î

### –ö—Ä–æ–∫ 2: –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó —Ç–æ–∫–µ–Ω–∞
1. –í—ñ–¥–∫—Ä–∏–π—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ (F12)
2. –ü–µ—Ä–µ–π–¥—ñ—Ç—å –Ω–∞ `/notifications`
3. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ª–æ–≥–∏:
   ```
   ‚úÖ Service Worker registered
   ‚úÖ Notification permission granted
   ‚úÖ FCM Token retrieved: ...
   ‚úÖ FCM token registered successfully
   ```

### –ö—Ä–æ–∫ 3: –í—ñ–¥–ø—Ä–∞–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è

**–í–∞—Ä—ñ–∞–Ω—Ç –ê: –ß–µ—Ä–µ–∑ —Ç–µ—Å—Ç–æ–≤—É —Å—Ç–æ—Ä—ñ–Ω–∫—É (—Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–æ)**
1. –í—ñ–¥–∫—Ä–∏–π—Ç–µ `http://localhost:4321/test-notification`
2. –ó–∞–ø–æ–≤–Ω—ñ—Ç—å —Ñ–æ—Ä–º—É:
   - **–ö–æ–º—É:** –∑–∞–ª–∏—à—Ç–µ –≤–∞—à username (–∞–±–æ –∑–º—ñ–Ω—ñ—Ç—å –Ω–∞ —ñ–Ω—à–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞)
   - **–¢–µ–∫—Å—Ç:** –≤–≤–µ–¥—ñ—Ç—å –±—É–¥—å-—è–∫–∏–π —Ç–µ–∫—Å—Ç
3. –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å "–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è"
4. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ —Å—Ç–æ—Ä—ñ–Ω–∫—É `/notifications` - –º–∞—î –∑'—è–≤–∏—Ç–∏—Å—è –Ω–æ–≤–µ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è

**–í–∞—Ä—ñ–∞–Ω—Ç –ë: –ß–µ—Ä–µ–∑ curl**
```bash
curl -X POST http://localhost:4321/api/notifications/webhook \
  -H "Content-Type: application/json" \
  -d '{
    "username": "–≤–∞—à_username",
    "notification_title": "–¢–µ—Å—Ç–æ–≤–µ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è"
  }'
```

**–í–∞—Ä—ñ–∞–Ω—Ç –í: –ß–µ—Ä–µ–∑ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞**
```javascript
fetch('/api/notifications/webhook', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    username: '–≤–∞—à_username',
    notification_title: 'üîî –¢–µ—Å—Ç–æ–≤–µ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è –∑ –∫–æ–Ω—Å–æ–ª—ñ!'
  })
})
.then(r => r.json())
.then(console.log);
```

## –©–æ –ø–µ—Ä–µ–≤—ñ—Ä—è—Ç–∏

### 1. Foreground —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è (–±—Ä–∞—É–∑–µ—Ä –≤—ñ–¥–∫—Ä–∏—Ç–∏–π)
- ‚úÖ –°–ø–æ–≤—ñ—â–µ–Ω–Ω—è –∑'—è–≤–ª—è—î—Ç—å—Å—è –≤ —Å–ø–∏—Å–∫—É –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ
- ‚úÖ –õ—ñ—á–∏–ª—å–Ω–∏–∫ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–∏—Ö –æ–Ω–æ–≤–ª—é—î—Ç—å—Å—è
- ‚úÖ –ë–µ–π–¥–∂ "–ù–æ–≤–µ" –≤—ñ–¥–æ–±—Ä–∞–∂–∞—î—Ç—å—Å—è
- ‚úÖ –Ü–∫–æ–Ω–∫–∞ –ø–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è (‚ö†Ô∏è) –ø–æ–∫–∞–∑—É—î—Ç—å—Å—è

### 2. Background —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è (–±—Ä–∞—É–∑–µ—Ä –∑–∞–∫—Ä–∏—Ç–∏–π/–∑–≥–æ—Ä–Ω—É—Ç–∏–π)
1. –ó–≥–æ—Ä–Ω—ñ—Ç—å –±—Ä–∞—É–∑–µ—Ä –∞–±–æ –ø–µ—Ä–µ–π–¥—ñ—Ç—å –Ω–∞ —ñ–Ω—à—É –≤–∫–ª–∞–¥–∫—É
2. –í—ñ–¥–ø—Ä–∞–≤—Ç–µ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è (—á–µ—Ä–µ–∑ curl –∞–±–æ –∑ —ñ–Ω—à–æ–≥–æ –ø—Ä–∏—Å—Ç—Ä–æ—é)
3. –ú–∞—î –∑'—è–≤–∏—Ç–∏—Å—è –Ω–∞—Ç–∏–≤–Ω–µ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è –û–°
4. –ü—Ä–∏ –∫–ª—ñ–∫—É –Ω–∞ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è –±—Ä–∞—É–∑–µ—Ä –≤—ñ–¥–∫—Ä–∏—î—Ç—å—Å—è –Ω–∞ `/notifications`

### 3. –ú–Ω–æ–∂–∏–Ω–Ω—ñ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è
1. –í—ñ–¥–ø—Ä–∞–≤—Ç–µ –¥–µ–∫—ñ–ª—å–∫–∞ —Å–ø–æ–≤—ñ—â–µ–Ω—å –ø—ñ–¥—Ä—è–¥
2. –í—Å—ñ –º–∞—é—Ç—å –∑'—è–≤–∏—Ç–∏—Å—è –≤ —Å–ø–∏—Å–∫—É
3. –õ—ñ—á–∏–ª—å–Ω–∏–∫ –º–∞—î –ø–æ–∫–∞–∑—É–≤–∞—Ç–∏ –ø—Ä–∞–≤–∏–ª—å–Ω—É –∫—ñ–ª—å–∫—ñ—Å—Ç—å

### 4. –ü–æ–∑–Ω–∞—á–µ–Ω–Ω—è —è–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–µ
1. –ö–ª—ñ–∫–Ω—ñ—Ç—å –Ω–∞ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è –∑ –±–µ–π–¥–∂–µ–º "–ù–æ–≤–µ"
2. –ë–µ–π–¥–∂ –º–∞—î –∑–Ω–∏–∫–Ω—É—Ç–∏
3. –õ—ñ—á–∏–ª—å–Ω–∏–∫ –º–∞—î –∑–º–µ–Ω—à–∏—Ç–∏—Å—è
4. –Ü–∫–æ–Ω–∫–∞ –ø–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è –º–∞—î –∑–Ω–∏–∫–Ω—É—Ç–∏

### 5. –ü–æ–∑–Ω–∞—á–∏—Ç–∏ –≤—Å—ñ —è–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω—ñ
1. –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –∫–Ω–æ–ø–∫—É "–í—Å—ñ –ø—Ä–æ—á–∏—Ç–∞–Ω—ñ"
2. –í—Å—ñ –±–µ–π–¥–∂—ñ "–ù–æ–≤–µ" –º–∞—é—Ç—å –∑–Ω–∏–∫–Ω—É—Ç–∏
3. –õ—ñ—á–∏–ª—å–Ω–∏–∫ –º–∞—î —Å—Ç–∞—Ç–∏ 0
4. –í—Å—ñ —ñ–∫–æ–Ω–∫–∏ –ø–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è –º–∞—é—Ç—å –∑–Ω–∏–∫–Ω—É—Ç–∏

## –õ–æ–≥–∏ –¥–ª—è –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

### –ö–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞
```
‚úÖ Service Worker registered
‚úÖ Notification permission granted
‚úÖ FCM Token retrieved: eozr3y...
‚úÖ FCM token registered successfully
Foreground message received: {notification: {...}, data: {...}}
```

### –¢–µ—Ä–º—ñ–Ω–∞–ª dev server
```
=== FCM Token Registration (SSR) ===
User: operator123
Token: eozr3y...
‚úÖ FCM token saved successfully

=== Webhook received ===
Username: operator123
Title: –¢–µ—Å—Ç–æ–≤–µ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è
‚úÖ Notification saved to database
‚úÖ FCM token found for user
‚úÖ Push notification sent successfully
```

## –ú–æ–∂–ª–∏–≤—ñ –ø—Ä–æ–±–ª–µ–º–∏

### –°–ø–æ–≤—ñ—â–µ–Ω–Ω—è –Ω–µ –ø—Ä–∏—Ö–æ–¥—è—Ç—å
1. **–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –¥–æ–∑–≤—ñ–ª:** –ë—Ä–∞—É–∑–µ—Ä ‚Üí –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è ‚Üí –°–ø–æ–≤—ñ—â–µ–Ω–Ω—è ‚Üí –î–æ–∑–≤–æ–ª–∏—Ç–∏
2. **–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ —Ç–æ–∫–µ–Ω:** –ö–æ–Ω—Å–æ–ª—å ‚Üí –ú–∞—î –±—É—Ç–∏ "FCM token registered successfully"
3. **–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ë–î:** –¢–æ–∫–µ–Ω –º–∞—î –±—É—Ç–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–∏–π –≤ —Ç–∞–±–ª–∏—Ü—ñ FCMToken
4. **–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ Firebase:** API –∫–ª—é—á—ñ –º–∞—é—Ç—å –±—É—Ç–∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ñ –≤ `.env`

### –ü–æ–º–∏–ª–∫–∞ "Unauthorized"
- –ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—å —â–æ –≤–∏ —É–≤—ñ–π—à–ª–∏ –≤ —Å–∏—Å—Ç–µ–º—É
- –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ cookies –≤ DevTools ‚Üí Application ‚Üí Cookies

### –ü–æ–º–∏–ª–∫–∞ "FCM token not found"
- –ü–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ —Å—Ç–æ—Ä—ñ–Ω–∫—É `/notifications`
- –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ —â–æ –¥–æ–∑–≤—ñ–ª –Ω–∞ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è –Ω–∞–¥–∞–Ω–æ
- –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ª–æ–≥–∏ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó —Ç–æ–∫–µ–Ω–∞

### Service Worker –Ω–µ —Ä–µ—î—Å—Ç—Ä—É—î—Ç—å—Å—è
- –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ —â–æ —Ñ–∞–π–ª `/firebase-messaging-sw.js` —ñ—Å–Ω—É—î
- –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –∫–æ–Ω—Å–æ–ª—å –Ω–∞ –ø–æ–º–∏–ª–∫–∏
- –°–ø—Ä–æ–±—É–π—Ç–µ –æ—á–∏—Å—Ç–∏—Ç–∏ –∫–µ—à –±—Ä–∞—É–∑–µ—Ä–∞

## –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è –Ω–∞ —Ä—ñ–∑–Ω–∏—Ö –ø—Ä–∏—Å—Ç—Ä–æ—è—Ö

### Desktop (Chrome/Edge)
- ‚úÖ Foreground: –°–ø–æ–≤—ñ—â–µ–Ω–Ω—è –≤ —Å–ø–∏—Å–∫—É
- ‚úÖ Background: –ù–∞—Ç–∏–≤–Ω–µ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è Windows/Mac/Linux

### Desktop (Firefox)
- ‚úÖ Foreground: –°–ø–æ–≤—ñ—â–µ–Ω–Ω—è –≤ —Å–ø–∏—Å–∫—É
- ‚úÖ Background: –ù–∞—Ç–∏–≤–Ω–µ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è

### Mobile (Chrome Android)
- ‚úÖ Foreground: –°–ø–æ–≤—ñ—â–µ–Ω–Ω—è –≤ —Å–ø–∏—Å–∫—É
- ‚úÖ Background: Push notification Android

### Mobile (Safari iOS)
- ‚ö†Ô∏è Safari iOS –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î Web Push (–ø–æ—Ç—Ä—ñ–±–µ–Ω iOS 16.4+)
- –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞: –í–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ Chrome –∞–±–æ Firefox –Ω–∞ iOS

## –ö–æ—Ä–∏—Å–Ω—ñ –∫–æ–º–∞–Ω–¥–∏

### –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ FCM —Ç–æ–∫–µ–Ω –≤ –ë–î
```bash
# –Ø–∫—â–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç–µ Turso CLI
turso db shell svup-operatorpuar1471 "SELECT * FROM FCMToken;"
```

### –û—á–∏—Å—Ç–∏—Ç–∏ –≤—Å—ñ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è
```bash
turso db shell svup-operatorpuar1471 "DELETE FROM Notification;"
```

### –û—á–∏—Å—Ç–∏—Ç–∏ FCM —Ç–æ–∫–µ–Ω–∏
```bash
turso db shell svup-operatorpuar1471 "DELETE FROM FCMToken;"
```

## –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è

–ú–æ–∂–Ω–∞ —Å—Ç–≤–æ—Ä–∏—Ç–∏ —Å–∫—Ä–∏–ø—Ç –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ—ó –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ —Ç–µ—Å—Ç–æ–≤–∏—Ö —Å–ø–æ–≤—ñ—â–µ–Ω—å:

```bash
#!/bin/bash
# test-notifications.sh

for i in {1..5}; do
  curl -X POST http://localhost:4321/api/notifications/webhook \
    -H "Content-Type: application/json" \
    -d "{
      \"username\": \"operator123\",
      \"notification_title\": \"–¢–µ—Å—Ç–æ–≤–µ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è #$i\"
    }"
  echo "Sent notification $i"
  sleep 2
done
```

–ó–∞–ø—É—Å–∫:
```bash
chmod +x test-notifications.sh
./test-notifications.sh
```
