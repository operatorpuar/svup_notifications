# –î—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø–æ–º–∏–ª–∫–∏ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó FCM —Ç–æ–∫–µ–Ω–∞

## –ü–æ–º–∏–ª–∫–∞
```
Error registering FCM token: AbortError: signal is aborted without reason
```

## –ê–Ω–∞–ª—ñ–∑

### –°—Ç–∞–¥—ñ—è –ø–æ–º–∏–ª–∫–∏: **–ö—Ä–æ–∫ 7 - –í—ñ–¥–ø—Ä–∞–≤–∫–∞ –Ω–∞ API**

```
‚úÖ –ö—Ä–æ–∫ 1-6: –£—Å–ø—ñ—à–Ω–æ
   - Service Worker –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω–æ
   - Firebase —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ
   - –î–æ–∑–≤—ñ–ª –æ—Ç—Ä–∏–º–∞–Ω–æ
   - FCM —Ç–æ–∫–µ–Ω –æ—Ç—Ä–∏–º–∞–Ω–æ: eozr3ymZLBhvANbIWjIOPd:APA91b...

‚ùå –ö—Ä–æ–∫ 7: –ü–û–ú–ò–õ–ö–ê
   - –ó–∞–ø–∏—Ç –¥–æ /api/fcm/register-token
   - Timeout –ø—ñ—Å–ª—è 30 —Å–µ–∫—É–Ω–¥
   - AbortError: signal is aborted without reason

‚ùì –ö—Ä–æ–∫ 8: –ù–µ –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è
   - –¢–æ–∫–µ–Ω –Ω–µ –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è –≤ –ë–î
```

## –ú–æ–∂–ª–∏–≤—ñ –ø—Ä–∏—á–∏–Ω–∏

### 1. Turso Database –ø–æ–≤—ñ–ª—å–Ω–æ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î ‚è±Ô∏è
**–ô–º–æ–≤—ñ—Ä–Ω—ñ—Å—Ç—å: –í–ò–°–û–ö–ê**

Turso (libSQL) –±–∞–∑–∞ –¥–∞–Ω–∏—Ö –º–æ–∂–µ –±—É—Ç–∏ –ø–æ–≤—ñ–ª—å–Ω–æ—é —á–µ—Ä–µ–∑:
- –•–æ–ª–æ–¥–Ω–∏–π —Å—Ç–∞—Ä—Ç (–±–∞–∑–∞ "–∑–∞—Å–Ω—É–ª–∞")
- –ì–µ–æ–≥—Ä–∞—Ñ—ñ—á–Ω–∞ –≤—ñ–¥—Å—Ç–∞–Ω—å (AWS US-East-2)
- –ü–æ–≤—ñ–ª—å–Ω–µ –∑'—î–¥–Ω–∞–Ω–Ω—è

**–†—ñ—à–µ–Ω–Ω—è:**
- –ó–±—ñ–ª—å—à–∏—Ç–∏ timeout (–≤–∂–µ –∑—Ä–æ–±–ª–µ–Ω–æ: 30 —Å–µ–∫)
- –í–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ –ª–æ–∫–∞–ª—å–Ω—É –ë–î –¥–ª—è dev
- –î–æ–¥–∞—Ç–∏ –∫–µ—à—É–≤–∞–Ω–Ω—è

### 2. API endpoint –Ω–µ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î üî¥
**–ô–º–æ–≤—ñ—Ä–Ω—ñ—Å—Ç—å: –°–ï–†–ï–î–ù–Ø**

–ú–æ–∂–ª–∏–≤–æ API endpoint –≤–∑–∞–≥–∞–ª—ñ –Ω–µ –≤–∏–∫–ª–∏–∫–∞—î—Ç—å—Å—è –∞–±–æ –ø–∞–¥–∞—î –∑ –ø–æ–º–∏–ª–∫–æ—é.

**–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞:**
–ü–æ–¥–∏–≤—ñ—Ç—å—Å—è –Ω–∞ –ª–æ–≥–∏ dev server - —á–∏ —î —Ç–∞–º:
```
=== FCM Token Registration API called ===
```

–Ø–∫—â–æ –ù–Ü ‚Üí –ø—Ä–æ–±–ª–µ–º–∞ –∑ —Ä–æ—É—Ç–∏–Ω–≥–æ–º
–Ø–∫—â–æ –¢–ê–ö ‚Üí –ø—Ä–æ–±–ª–µ–º–∞ –∑ –ë–î

### 3. –ü—Ä–æ–±–ª–µ–º–∞ –∑ –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—î—é üîê
**–ô–º–æ–≤—ñ—Ä–Ω—ñ—Å—Ç—å: –ù–ò–ó–¨–ö–ê**

Cookies –º–æ–∂—É—Ç—å –Ω–µ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç–∏—Å—è –≤ –∑–∞–ø–∏—Ç—ñ.

**–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞:**
–ü–æ–¥–∏–≤—ñ—Ç—å—Å—è —á–∏ —î –≤ –ª–æ–≥–∞—Ö:
```
‚ùå Unauthorized - no username in cookies
```

## –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è

### –¢–µ—Å—Ç 1: –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—ñ API
–í—ñ–¥–∫—Ä–∏–π—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ —ñ –≤–∏–∫–æ–Ω–∞–π—Ç–µ:

```javascript
fetch('/api/fcm/register-token', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ fcm_token: 'test-token' })
})
.then(r => r.json())
.then(console.log)
.catch(console.error);
```

**–û—á—ñ–∫—É–≤–∞–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- –Ø–∫—â–æ –ø—Ä–∞—Ü—é—î: `{success: true}` –∞–±–æ `{error: "..."}`
- –Ø–∫—â–æ –Ω–µ –ø—Ä–∞—Ü—é—î: Network error –∞–±–æ timeout

### –¢–µ—Å—Ç 2: –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —à–≤–∏–¥–∫–æ—Å—Ç—ñ –ë–î
–í–∏–∫–æ–Ω–∞–π—Ç–µ –≤ —Ç–µ—Ä–º—ñ–Ω–∞–ª—ñ:

```bash
time curl -X POST http://localhost:4321/api/fcm/register-token \
  -H "Content-Type: application/json" \
  -d '{"fcm_token":"test"}' \
  -b "jwt_token=YOUR_TOKEN;username=YOUR_USERNAME"
```

**–û—á—ñ–∫—É–≤–∞–Ω–∏–π —á–∞—Å:**
- ‚úÖ < 5 —Å–µ–∫—É–Ω–¥: –ù–æ—Ä–º–∞–ª—å–Ω–æ
- ‚ö†Ô∏è 5-15 —Å–µ–∫—É–Ω–¥: –ü–æ–≤—ñ–ª—å–Ω–æ
- ‚ùå > 15 —Å–µ–∫—É–Ω–¥: –î—É–∂–µ –ø–æ–≤—ñ–ª—å–Ω–æ (timeout)

### –¢–µ—Å—Ç 3: –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ª–æ–≥—ñ–≤ —Å–µ—Ä–≤–µ—Ä–∞
–ü–æ–¥–∏–≤—ñ—Ç—å—Å—è –Ω–∞ –≤–∏–≤—ñ–¥ `npm run dev`:

**–Ø–∫—â–æ –±–∞—á–∏—Ç–µ:**
```
=== FCM Token Registration API called ===
‚úÖ User authenticated: operator123
Checking for existing FCM token...
```
‚Üí API –ø—Ä–∞—Ü—é—î, –ø—Ä–æ–±–ª–µ–º–∞ –∑ –ë–î

**–Ø–∫—â–æ –ù–ï –±–∞—á–∏—Ç–µ:**
```
=== FCM Token Registration API called ===
```
‚Üí API –Ω–µ –≤–∏–∫–ª–∏–∫–∞—î—Ç—å—Å—è, –ø—Ä–æ–±–ª–µ–º–∞ –∑ —Ä–æ—É—Ç–∏–Ω–≥–æ–º

## –®–≤–∏–¥–∫–µ —Ä—ñ—à–µ–Ω–Ω—è

### –í–∞—Ä—ñ–∞–Ω—Ç 1: –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—è (—Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–æ)
–ù–µ —á–µ–∫–∞—Ç–∏ –Ω–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å API, –ø—Ä–æ–¥–æ–≤–∂–∏—Ç–∏ —Ä–æ–±–æ—Ç—É –¥–æ–¥–∞—Ç–∫—É:

```javascript
// –í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ —ñ –∑–∞–±—É—Ç–∏
registerFCMToken(token).catch(err => {
  console.warn('FCM registration failed, will retry later');
});

// –ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—é
setupMessageHandler();
```

### –í–∞—Ä—ñ–∞–Ω—Ç 2: –õ–æ–∫–∞–ª—å–Ω–∞ –ë–î –¥–ª—è dev
–í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –ª–æ–∫–∞–ª—å–Ω—É Turso –ë–î –∑–∞–º—ñ—Å—Ç—å remote:

```bash
# .env
ASTRO_DB_REMOTE_URL=file:./local.db
```

### –í–∞—Ä—ñ–∞–Ω—Ç 3: Retry –∑ –µ–∫—Å–ø–æ–Ω–µ–Ω—Ü—ñ–π–Ω–æ—é –∑–∞—Ç—Ä–∏–º–∫–æ—é
```javascript
async function registerWithBackoff(token, attempt = 0) {
  const delays = [0, 2000, 5000, 10000]; // 0s, 2s, 5s, 10s
  
  try {
    await registerFCMToken(token);
  } catch (error) {
    if (attempt < delays.length - 1) {
      await new Promise(r => setTimeout(r, delays[attempt + 1]));
      return registerWithBackoff(token, attempt + 1);
    }
  }
}
```

## –ù–∞—Å—Ç—É–ø–Ω—ñ –∫—Ä–æ–∫–∏

1. **–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ª–æ–≥–∏ dev server** - —á–∏ –≤–∏–∫–ª–∏–∫–∞—î—Ç—å—Å—è API?
2. **–í–∏–∫–æ–Ω–∞–π—Ç–µ –¢–µ—Å—Ç 1** - —á–∏ –¥–æ—Å—Ç—É–ø–Ω–∏–π endpoint?
3. **–í–∏–º—ñ—Ä—è–π—Ç–µ —á–∞—Å –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –ë–î** - —á–∏ —à–≤–∏–¥–∫–æ –ø—Ä–∞—Ü—é—î Turso?
4. **–ó–∞—Å—Ç–æ—Å—É–π—Ç–µ –í–∞—Ä—ñ–∞–Ω—Ç 1** - –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—è

## –°—Ç–∞—Ç—É—Å

- ‚úÖ Firebase –ø—Ä–∞—Ü—é—î
- ‚úÖ –¢–æ–∫–µ–Ω –æ—Ç—Ä–∏–º—É—î—Ç—å—Å—è
- ‚ùå –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è –Ω–∞ backend –Ω–µ –ø—Ä–∞—Ü—é—î
- ‚ùì –ü—Ä–∏—á–∏–Ω–∞: –ü–æ—Ç—Ä—ñ–±–Ω–∞ –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

**–î–æ–¥–∞—Ç–æ–∫ –ø—Ä–∞—Ü—é—î?** –¢–ê–ö - —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è –ø—Ä–æ—Å—Ç–æ –Ω–µ –±—É–¥—É—Ç—å –ø—Ä–∏—Ö–æ–¥–∏—Ç–∏
**–ö—Ä–∏—Ç–∏—á–Ω–∞ –ø–æ–º–∏–ª–∫–∞?** –ù–Ü - –º–æ–∂–Ω–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –¥–æ–¥–∞—Ç–æ–∫
