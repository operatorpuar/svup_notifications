---
// Webhook for receiving notifications from external backend
import { db, FCMToken, eq } from 'astro:db';
import { initializeApp, cert, getApps, type App } from 'firebase-admin/app';
import { getMessaging } from 'firebase-admin/messaging';

// Initialize Firebase Admin SDK (singleton pattern)
let firebaseAdmin: App;

function getFirebaseAdmin(): App {
  if (!firebaseAdmin) {
    const existingApps = getApps();
    if (existingApps.length > 0) {
      firebaseAdmin = existingApps[0];
    } else {
      // Validate credentials before initialization
      const projectId = import.meta.env.FIREBASE_PROJECT_ID;
      const clientEmail = import.meta.env.FIREBASE_CLIENT_EMAIL;
      const privateKey = import.meta.env.FIREBASE_PRIVATE_KEY;

      if (!projectId || !clientEmail || !privateKey) {
        throw new Error('Missing Firebase Admin SDK credentials');
      }

      firebaseAdmin = initializeApp({
        credential: cert({
          projectId,
          clientEmail,
          privateKey: privateKey.replace(/\\n/g, '\n')
        })
      });
    }
  }
  return firebaseAdmin;
}

let result = { success: false, error: '', fcmMessageId: null as string | null };

if (Astro.request.method === 'POST') {
  try {
    console.log('=== Webhook received ===');
    
    const body = await Astro.request.json();
    let { username, notification_title } = body;
    
    // If username not provided in body, try to get from cookies
    if (!username) {
      username = Astro.cookies.get('username')?.value;
      console.log('Username from cookies:', username);
    }
    
    console.log('Username:', username);
    console.log('Title:', notification_title);
    
    if (!username || !notification_title) {
      result = { 
        success: false, 
        error: 'username and notification_title are required',
        fcmMessageId: null
      };
    } else {
      // Get FCM token
      console.log('Looking for FCM token...');
      const fcmRecord = await db
        .select()
        .from(FCMToken)
        .where(eq(FCMToken.username, username))
        .get();
      
      if (!fcmRecord?.fcm_token) {
        console.warn('‚ö†Ô∏è No FCM token found for user');
        result = {
          success: false,
          error: 'No FCM token registered for user',
          fcmMessageId: null
        };
      } else {
        console.log('‚úÖ FCM token found for user');
        try {
          const admin = getFirebaseAdmin();
          const messaging = getMessaging(admin);
          
          // Generate unique notification ID
          const notificationId = `notif_${Date.now()}_${Math.random().toString(36).substring(2, 11)}`;
          
          console.log('Sending push notification...');
          // Send FCM push notification (client will save to DB after receiving)
          const fcmMessageId = await messaging.send({
            token: fcmRecord.fcm_token,
            notification: {
              title: '–°–í–£–ü',
              body: notification_title
            },
            data: {
              notificationBody: notification_title,
              notificationId: notificationId,
              timestamp: new Date().toISOString()
            },
            webpush: {
              fcmOptions: {
                link: '/notifications'
              }
            }
          });
          console.log('‚úÖ Push notification sent successfully, FCM ID:', fcmMessageId);
          
          result = {
            success: true,
            error: '',
            fcmMessageId: fcmMessageId
          };
        } catch (fcmError: any) {
          console.error('‚ùå FCM send error:', fcmError);
          
          // Handle invalid/expired token
          if (fcmError.code === 'messaging/invalid-registration-token' || 
              fcmError.code === 'messaging/registration-token-not-registered') {
            try {
              await db.delete(FCMToken).where(eq(FCMToken.username, username));
              console.log('üóëÔ∏è Invalid token removed');
            } catch (deleteError: any) {
              console.error('Failed to delete invalid token:', deleteError.message);
            }
            
            result = {
              success: false,
              error: 'Invalid or expired FCM token (token removed)',
              fcmMessageId: null
            };
          } else {
            result = {
              success: false,
              error: `FCM send failed: ${fcmError.message}`,
              fcmMessageId: null
            };
          }
        }
      }
    }
  } catch (error: any) {
    console.error('‚ùå Webhook error:', error);
    result = {
      success: false,
      error: error.message || 'Internal server error',
      fcmMessageId: null
    };
  }
}

// Return JSON response
return new Response(JSON.stringify(result), {
  status: result.success ? 200 : (result.error.includes('required') ? 400 : 500),
  headers: { 'Content-Type': 'application/json' }
});
---
