---
// Webhook for receiving notifications from external backend
import { db, Notification, FCMToken, eq } from 'astro:db';
import { initializeApp, cert, getApps, type App } from 'firebase-admin/app';
import { getMessaging } from 'firebase-admin/messaging';

// Initialize Firebase Admin SDK (singleton pattern)
let firebaseAdmin: App;

function getFirebaseAdmin(): App {
  if (!firebaseAdmin) {
    const existingApps = getApps();
    if (existingApps.length > 0) {
      firebaseAdmin = existingApps[0];
    } else {
      firebaseAdmin = initializeApp({
        credential: cert({
          projectId: import.meta.env.FIREBASE_PROJECT_ID,
          clientEmail: import.meta.env.FIREBASE_CLIENT_EMAIL,
          privateKey: import.meta.env.FIREBASE_PRIVATE_KEY?.replace(/\\n/g, '\n')
        })
      });
    }
  }
  return firebaseAdmin;
}

let result = { success: false, error: '', notification: null as any };

if (Astro.request.method === 'POST') {
  try {
    console.log('=== Webhook received ===');
    
    const body = await Astro.request.json();
    const { username, notification_title } = body;
    
    console.log('Username:', username);
    console.log('Title:', notification_title);
    
    if (!username || !notification_title) {
      result = { 
        success: false, 
        error: 'username and notification_title are required',
        notification: null
      };
    } else {
      // Insert notification into database
      console.log('Saving notification to database...');
      const insertedNotifications = await db.insert(Notification).values({
        username,
        notification_title,
        status: 'New',
        created_at: new Date()
      }).returning();
      
      const notification = insertedNotifications[0];
      console.log('✅ Notification saved to database, ID:', notification.id);
      
      // Get FCM token
      console.log('Looking for FCM token...');
      const fcmRecord = await db
        .select()
        .from(FCMToken)
        .where(eq(FCMToken.username, username))
        .get();
      
      if (fcmRecord?.fcm_token) {
        console.log('✅ FCM token found for user');
        try {
          const admin = getFirebaseAdmin();
          const messaging = getMessaging(admin);
          
          console.log('Sending push notification...');
          await messaging.send({
            token: fcmRecord.fcm_token,
            notification: {
              title: 'СВУП',
              body: notification_title
            },
            data: {
              notificationId: notification.id.toString(),
              timestamp: notification.created_at.toISOString()
            }
          });
          console.log('✅ Push notification sent successfully');
        } catch (fcmError) {
          console.error('❌ FCM send error:', fcmError);
        }
      } else {
        console.warn('⚠️ No FCM token found for user');
      }
      
      result = {
        success: true,
        error: '',
        notification: {
          id: notification.id,
          username: notification.username,
          notification_title: notification.notification_title,
          status: notification.status,
          created_at: notification.created_at.toISOString()
        }
      };
    }
  } catch (error: any) {
    console.error('❌ Webhook error:', error);
    result = {
      success: false,
      error: error.message || 'Internal server error',
      notification: null
    };
  }
}

// Return JSON response
return new Response(JSON.stringify(result), {
  status: result.success ? 200 : (result.error.includes('required') ? 400 : 500),
  headers: { 'Content-Type': 'application/json' }
});
---
