---
// Test page for sending notifications
import { requireAuth } from '../lib/auth-middleware';

const username = requireAuth(Astro.cookies);
if (!username) {
  return Astro.redirect('/');
}

let result = { success: false, message: '', error: '' };

if (Astro.request.method === 'POST') {
  try {
    const formData = await Astro.request.formData();
    const notification_title = formData.get('notification_title')?.toString();
    const target_username = formData.get('target_username')?.toString() || username;

    console.log('=== Test Notification ===');
    console.log('From:', username);
    console.log('To:', target_username);
    console.log('Title:', notification_title);

    if (!notification_title) {
      result = { success: false, message: '', error: 'Notification title required' };
    } else {
      // Call webhook endpoint
      const webhookUrl = `${Astro.url.origin}/webhook`;
      
      console.log('Calling webhook:', webhookUrl);
      
      const response = await fetch(webhookUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          username: target_username,
          notification_title: notification_title
        })
      });

      let data = { error: 'Unknown error' };
      
      try {
        const responseText = await response.text();
        if (responseText) {
          data = JSON.parse(responseText);
        } else {
          data = { error: 'Empty response from webhook' };
        }
      } catch (jsonError) {
        console.error('Failed to parse webhook response:', jsonError);
        data = { error: 'Invalid JSON response from webhook' };
      }
      
      if (response.ok) {
        console.log('‚úÖ Notification sent successfully');
        result = { 
          success: true, 
          message: `Notification sent to ${target_username}!`,
          error: '' 
        };
      } else {
        console.error('‚ùå Failed to send notification:', data);
        result = { 
          success: false, 
          message: '',
          error: data.error || 'Failed to send notification' 
        };
      }
    }
  } catch (error: any) {
    console.error('‚ùå Error sending notification:', error);
    result = { 
      success: false, 
      message: '',
      error: error.message || 'Server error' 
    };
  }
}
---

<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Notifications - –°–í–£–ü</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            padding: 20px;
            background: #1e293b;
            color: #fff;
            max-width: 600px;
            margin: 0 auto;
        }
        h1 {
            color: #3b82f6;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            color: #94a3b8;
        }
        input, textarea {
            width: 100%;
            padding: 10px;
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 5px;
            color: #fff;
            font-size: 14px;
        }
        input:focus, textarea:focus {
            outline: none;
            border-color: #3b82f6;
        }
        button {
            padding: 12px 24px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
        }
        button:hover {
            background: #2563eb;
        }
        .success {
            background: #10b981;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .error {
            background: #ef4444;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .info {
            background: #0f172a;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border: 1px solid #334155;
        }
        .back-link {
            display: inline-block;
            margin-top: 20px;
            color: #3b82f6;
            text-decoration: none;
        }
        .back-link:hover {
            text-decoration: underline;
        }
        code {
            background: #0f172a;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <h1>üß™ Test Push Notifications</h1>
    
    <div class="info">
        <strong>‚ÑπÔ∏è –Ü–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è:</strong>
        <ol>
            <li>–ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—å —â–æ –≤–∏ –¥–æ–∑–≤–æ–ª–∏–ª–∏ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è –≤ –±—Ä–∞—É–∑–µ—Ä—ñ</li>
            <li>–í—ñ–¥–∫—Ä–∏–π—Ç–µ —Å—Ç–æ—Ä—ñ–Ω–∫—É <code>/notifications</code> –≤ —ñ–Ω—à—ñ–π –≤–∫–ª–∞–¥—Ü—ñ</li>
            <li>–ó–∞–ø–æ–≤–Ω—ñ—Ç—å —Ñ–æ—Ä–º—É –Ω–∏–∂—á–µ —ñ –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å "–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏"</li>
            <li>–°–ø–æ–≤—ñ—â–µ–Ω–Ω—è –º–∞—î –∑'—è–≤–∏—Ç–∏—Å—è –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ notifications</li>
        </ol>
        <p><strong>–ü–æ—Ç–æ—á–Ω–∏–π –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á:</strong> <code>{username}</code></p>
    </div>

    {result.success && (
        <div class="success">
            ‚úÖ {result.message}
        </div>
    )}

    {result.error && (
        <div class="error">
            ‚ùå {result.error}
        </div>
    )}

    <form method="POST">
        <div class="form-group">
            <label for="target_username">–ö–æ–º—É (username):</label>
            <input 
                type="text" 
                id="target_username" 
                name="target_username" 
                value={username}
                placeholder="operator123"
            />
            <small style="color: #64748b;">–ó–∞–ª–∏—à—Ç–µ –ø–æ—Ä–æ–∂–Ω—ñ–º —â–æ–± –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ —Å–æ–±—ñ</small>
        </div>

        <div class="form-group">
            <label for="notification_title">–¢–µ–∫—Å—Ç —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è:</label>
            <textarea 
                id="notification_title" 
                name="notification_title" 
                rows="3"
                placeholder="‚ö†Ô∏è –ù–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è: –ó–∞–≤–¥–∞–Ω–Ω—è '–°–ï–î–û' –∑–∞–∫—ñ–Ω—á—É—î—Ç—å—Å—è –∑–∞–≤—Ç—Ä–∞ (12.11.2025 –æ 10:00)!"
                required
            ></textarea>
        </div>

        <button type="submit">üì§ –í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è</button>
    </form>

    <a href="/notifications" class="back-link">‚Üê –ù–∞–∑–∞–¥ –¥–æ —Å–ø–æ–≤—ñ—â–µ–Ω—å</a>

    <div class="info" style="margin-top: 30px;">
        <strong>üí° –Ø–∫ —Ü–µ –ø—Ä–∞—Ü—é—î:</strong>
        <ol>
            <li>–§–æ—Ä–º–∞ –≤—ñ–¥–ø—Ä–∞–≤–ª—è—î POST –∑–∞–ø–∏—Ç –Ω–∞ —Ü—é –∂ —Å—Ç–æ—Ä—ñ–Ω–∫—É (SSR)</li>
            <li>SSR –≤–∏–∫–ª–∏–∫–∞—î <code>/webhook</code></li>
            <li>Webhook –∑–±–µ—Ä—ñ–≥–∞—î —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è –≤ –ë–î</li>
            <li>Webhook –∑–Ω–∞—Ö–æ–¥–∏—Ç—å FCM —Ç–æ–∫–µ–Ω –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞</li>
            <li>Webhook –≤—ñ–¥–ø—Ä–∞–≤–ª—è—î push —á–µ—Ä–µ–∑ Firebase Admin SDK</li>
            <li>Firebase –¥–æ—Å—Ç–∞–≤–ª—è—î —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è –Ω–∞ –ø—Ä–∏—Å—Ç—Ä—ñ–π</li>
            <li>–°–ø–æ–≤—ñ—â–µ–Ω–Ω—è –∑'—è–≤–ª—è—î—Ç—å—Å—è –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ notifications</li>
        </ol>
    </div>
</body>
</html>
